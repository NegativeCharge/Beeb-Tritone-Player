;Tritone beeper music engine - HIGHLY OPTIMIZED VERSION
;Original Z80 code by Shiru 03'2011, released as Public Domain
;1tracker version by Shiru 03'2018
;6502 engine port by utz 03'2024
;Ported to the BBC Micro by Negative Charge 03'2024
;Optimized for speed and cycle balance

; Constants
OSBYTE                  = $FFF4
OSWRCH                  = $FFEE
OSNEWL                  = $FFE7
SHEILABASE              = $FE00
SYSVIA_DDRA             = SHEILABASE + $43
SYSVIA_ORAS             = SHEILABASE + $4F
SYSVIA_REGB             = SHEILABASE + $40

DISPLAY_START           = $7c00
DEBUG                   = TRUE
ROW_DEBUG               = FALSE

OP_NOP                  = $EA
OP_ROL_A                = $2A

; Zero Page - optimally arranged
ORG     $60
GUARD   $90

.vars_start

; CRITICAL: Most frequently accessed in play_note loop
.ch0_acc_lo         SKIP 1      ; $60
.ch0_acc_hi         SKIP 1      ; $61
.ch1_acc_lo         SKIP 1      ; $62
.ch1_acc_hi         SKIP 1      ; $63
.ch2_acc_lo         SKIP 1      ; $64
.ch2_acc_hi         SKIP 1      ; $65

.ch0_div_lo         SKIP 1      ; $66
.ch0_div_hi         SKIP 1      ; $67
.ch1_div_lo         SKIP 1      ; $68
.ch1_div_hi         SKIP 1      ; $69
.ch2_div_lo         SKIP 1      ; $6A
.ch2_div_hi         SKIP 1      ; $6B

.ch0_duty           SKIP 1      ; $6C
.ch1_duty           SKIP 1      ; $6D
.ch2_duty           SKIP 1      ; $6E

; Counter for row loop
.counter_lo         SKIP 1      ; $6F
.counter_hi         SKIP 1      ; $70

; Less critical variables
.loop_ptr           SKIP 2      ; $71-72
.pattern_ptr        SKIP 2      ; $73-74
.speed              SKIP 2      ; $75-76
.drum               SKIP 1      ; $77
.row_length         SKIP 2      ; $78-79

.vars_end

ORG     &1900
GUARD   DISPLAY_START

.start

INCLUDE "lib\os.s.6502" 

; Ultra-fast sound write
MACRO sound_write_ultra
    sta     SYSVIA_ORAS
ENDMACRO

; Write with delay
MACRO sound_write_slow
    sta     SYSVIA_ORAS
    lda     #%00000000
    sta     SYSVIA_REGB
    nop
    nop
    nop
    lda     #%00001000
    sta     SYSVIA_REGB
ENDMACRO

MACRO RESET_SOUND_CHIP
    lda     #%11111111
    sound_write_slow
    lda     #%11011111
    sound_write_slow
    lda     #%10111111
    sound_write_slow
    lda     #%10011111
    sound_write_slow
ENDMACRO

.init
    ; Print Track Title
    ldx     #1
    ldy     #22
    jsr     moveTextCursor

    jsr     printString
    equs    "The Liberty Bell",0

    ; Print Track Artist
    ldx     #1
    ldy     #24
    jsr     moveTextCursor

    jsr     printString
    equs    "John Philip Sousa",0

    ; Set up audio
    lda     #%11111111
    sta     SYSVIA_DDRA

    sei

    RESET_SOUND_CHIP

    ; Period to 1 on all tone channels
    lda     #%10000001
    sound_write_slow
    lda     #%00000000
    sound_write_slow
    
    lda     #%10100001
    sound_write_slow
    lda     #%00000000
    sound_write_slow
    
    lda     #%11000001
    sound_write_slow
    lda     #%00000000
    sound_write_slow

    lda     #%00000000
    sta     SYSVIA_REGB
    
    lda     #LO(music_data)
    ldx     #HI(music_data)

.play

    pha
    txa
    pha
    
    ; Ultra-fast zero page reset - unrolled
    lda     #0
    sta     $60     ; ch0_acc_lo
    sta     $61     ; ch0_acc_hi
    sta     $62     ; ch1_acc_lo
    sta     $63     ; ch1_acc_hi
    sta     $64     ; ch2_acc_lo
    sta     $65     ; ch2_acc_hi
    sta     $66     ; ch0_div_lo
    sta     $67     ; ch0_div_hi
    sta     $68     ; ch1_div_lo
    sta     $69     ; ch1_div_hi
    sta     $6A     ; ch2_div_lo
    sta     $6B     ; ch2_div_hi
    sta     $6C     ; ch0_duty
    sta     $6D     ; ch1_duty
    sta     $6E     ; ch2_duty
    
    pla
    sta     pattern_ptr+1
    pla
    sta     pattern_ptr+0

IF DEBUG
        pha:txa:pha:tya:pha

        ldx     #1
        ldy     #1
        jsr     moveTextCursor
        jsr     printString
        equs    "Pattern Pointer: ",0

        lda     pattern_ptr+1
        jsr     s_print_hex
        lda     pattern_ptr+0
        jsr     s_print_hex
        jsr     OSNEWL

        pla:tay:pla:tax:pla
ENDIF

    ldy     #0
    lda     (pattern_ptr),y
    sta     loop_ptr+0

    iny
    lda     (pattern_ptr),y
    sta     loop_ptr+1
    
IF DEBUG
        pha:txa:pha:tya:pha

        ldx     #1
        ldy     #2
        jsr     moveTextCursor

        jsr     printString
        equs    "Loop Pointer   : ",0

        lda     loop_ptr+1
        jsr     s_print_hex
        lda     loop_ptr+0
        jsr     s_print_hex
        jsr     OSNEWL

        pla:tay:pla:tax:pla
ENDIF

    ; Optimized pointer increment
    lda     pattern_ptr+0
    clc
    adc     #5
    sta     pattern_ptr+0
    bcc     play_loop
    inc     pattern_ptr+1

.play_loop

    ldy     #1
    lda     (pattern_ptr),y
    bne     no_loop
    
.return_loop

    lda     loop_ptr+0
    sta     pattern_ptr+0
    lda     loop_ptr+1
    sta     pattern_ptr+1
    jmp     play_loop

.no_loop
    iny
    lda     (pattern_ptr),y
    sta     row_length+0
    iny
    lda     (pattern_ptr),y
    sta     row_length+1

IF DEBUG
        pha:txa:pha:tya:pha

        ldx     #1
        ldy     #4
        jsr     moveTextCursor

        jsr     printString
        equs    "Speed          : ",0

        lda     row_length+1
        jsr     s_print_hex
        lda     row_length+0
        jsr     s_print_hex
        jsr     OSNEWL

        pla:tay:pla:tax:pla
ENDIF

jmp     row

.pattern_end
    cli

    RESET_SOUND_CHIP

    rts

.row
    ldy     #0
    lda     (pattern_ptr),y
    bne     ch0

    ; Fast channel 0 clear - use A=0 already loaded
    sta     $6C     ; ch0_duty
    sta     $66     ; ch0_div_lo
    sta     $67     ; ch0_div_hi
    sta     drum
    jmp     skip_ch0

.ch0
    cmp     #$ff
    beq     pattern_end
    cmp     #$01
    beq     skip_ch0
    cmp     #$80
    bcc     skip_drum
    sta     drum

    iny
    lda     (pattern_ptr),y

.skip_drum
    ; Store duty in high nibble, freq_hi in low nibble
    tax                 ; Save original value
    and     #$0f
    sta     ch0_div_hi
    txa
    and     #$f0
    sta     ch0_duty
    iny
    lda     (pattern_ptr),y
    sta     ch0_div_lo

.skip_ch0
    iny
    lda     (pattern_ptr),y
    bne     ch1

    ; Fast channel 1 clear
    sta     $6D     ; ch1_duty (A=0)
    sta     $68     ; ch1_div_lo
    sta     $69     ; ch1_div_hi
    jmp     skip_ch1

.ch1
    cmp     #$01
    beq     skip_ch1
    tax
    and     #$0f
    sta     $69     ; ch1_div_hi
    txa
    and     #$f0
    sta     $6D     ; ch1_duty

    iny
    lda     (pattern_ptr),y
    sta     $68     ; ch1_div_lo

.skip_ch1
    iny
    lda     (pattern_ptr),y
    bne     ch2
    
    ; Fast channel 2 clear
    sta     $6E     ; ch2_duty (A=0)
    sta     $6A     ; ch2_div_lo
    sta     $6B     ; ch2_div_hi
    jmp     skip_ch2

.ch2
    cmp     #$01
    beq     skip_ch2
    tax
    and     #$0f
    sta     $6B     ; ch2_div_hi
    txa
    and     #$f0
    sta     $6E     ; ch2_duty

    iny
    lda     (pattern_ptr),y
    sta     $6A     ; ch2_div_lo

.skip_ch2
    ; Update pattern pointer - optimized
    tya
    adc     pattern_ptr+0
    sta     pattern_ptr+0
    bcc     setup_play_loop
    inc     pattern_ptr+1

.setup_play_loop
    ; Initialize counter from row_length
    lda     row_length+0
    sta     counter_lo
    lda     row_length+1
    sta     counter_hi
    
    ; Safety: If speed is 0, skip the row
    ora     counter_lo
    beq     row_finished

; ===================================================================
; CRITICAL INNER LOOP - FULLY CYCLE-BALANCED
; This is the most frequently executed code - every cycle matters!
; ===================================================================
.play_note
    ; --- CHANNEL 0 (28 cycles) ---
    clc                         ; 2
    lda     ch0_acc_lo          ; 3
    adc     ch0_div_lo          ; 3
    sta     ch0_acc_lo          ; 3
    lda     ch0_acc_hi          ; 3
    adc     ch0_div_hi          ; 3
    sta     ch0_acc_hi          ; 3
    cmp     ch0_duty            ; 3 - sets carry if acc_hi >= duty
    lda     #$00                ; 2
    adc     #$00                ; 2 - A = carry (0 or 1)
    
    ; --- CHANNEL 1 (28 cycles) ---
    tax                         ; 2 - save ch0 result
    clc                         ; 2
    lda     ch1_acc_lo          ; 3
    adc     ch1_div_lo          ; 3
    sta     ch1_acc_lo          ; 3
    lda     ch1_acc_hi          ; 3
    adc     ch1_div_hi          ; 3
    sta     ch1_acc_hi          ; 3
    cmp     ch1_duty            ; 3
    lda     #$00                ; 2
    adc     #$00                ; 2
    
    ; --- CHANNEL 2 (28 cycles) ---
    ora     $00,x               ; 4 - OR with ch0 (using X as offset from $00)
    tax                         ; 2 - save ch0|ch1 result
    clc                         ; 2
    lda     ch2_acc_lo          ; 3
    adc     ch2_div_lo          ; 3
    sta     ch2_acc_lo          ; 3
    lda     ch2_acc_hi          ; 3
    adc     ch2_div_hi          ; 3
    sta     ch2_acc_hi          ; 3
    cmp     ch2_duty            ; 3
    lda     #$00                ; 2
    adc     #$00                ; 2
    
    ; --- MIX & OUTPUT (12 cycles) ---
    ora     $00,x               ; 4 - OR with ch0|ch1
    tax                         ; 2 - save final mix
    lda     volume_table,x      ; 4 - lookup volume (2 cycles saved!)
    sta     SYSVIA_ORAS         ; 4
    
    ; --- COUNTER DECREMENT (17 cycles) ---
    ; Branch-free 16-bit decrement
    lda     counter_lo          ; 3
    bne     skip_hi_dec         ; 2/3
    dec     counter_hi          ; 5
    beq     row_finished        ; 2/3
.skip_hi_dec
    dec     counter_lo          ; 5
    jmp     play_note           ; 3

.row_finished
    jmp     row

; Volume lookup table - converts 0/1 to $9F/$90
; This saves 6 cycles per sample vs branch!
.volume_table
    equb    $9F                 ; 0 = off (max attenuation)
    equb    $90                 ; 1 = on (min attenuation)

.s_print_hex
        pha
        lsr     a
        lsr     a
        lsr     a
        lsr     a
        jsr     printNybble
        pla
        and     #&0f
.printNybble
        sed
        clc
        adc     #&90
        adc     #&40
        cld
        jmp     OSWRCH

INCLUDE "tracks\liberty_bell_tritone.6502" 

.end

SAVE "MAIN",start,end,init

PRINT "-----------------------"
PRINT " 1-BIT TRITONE PLAYER  "
PRINT "-----------------------"
PRINT "CODE size       = ", ~end-start
PRINT "-----------------------"
PRINT "HIGH WATERMARK  = ", ~P%
PRINT "FREE            = ", ~start+end
PRINT "-----------------------"

PUTBASIC "loader.bas","LOADER"
PUTFILE  "BOOT","!BOOT",$ffff